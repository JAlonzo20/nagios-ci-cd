name: Nagios CI/CD local

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REPO_CFG_DIR: nagios_conf
  NAGIOS_ETC_DIR: /usr/local/nagios/etc
  REPO_CFG_FILE: nagios_conf/nagios.cfg
  NAGIOS_CFG_FILE: /usr/local/nagios/etc/nagios.cfg

jobs:
  validate_and_deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validar configuración desde el repo
        run: |
          test -f "$REPO_CFG_FILE"
          sudo /usr/local/nagios/bin/nagios -v "$REPO_CFG_FILE"

      - name: Copiar configs al directorio de Nagios
        run: |
          rsync -az --delete "${REPO_CFG_DIR}/" "${NAGIOS_ETC_DIR}/"

      - name: Validar configuración final y recargar Nagios
        run: |
          sudo /usr/local/nagios/bin/nagios -v "$NAGIOS_CFG_FILE"
          sudo systemctl reload nagios
